{% extends "base.html" %}

{% block title %}Công thức nấu ăn - Eat Today{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-book-open text-success me-3"></i>Công thức nấu ăn
            </h1>
            
            <!-- Search Bar -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm công thức...">
                        <button class="btn btn-success" type="button" onclick="searchRecipes()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary w-100" onclick="loadRecipes()">
                        <i class="fas fa-refresh me-2"></i>Làm mới
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center" style="display: none;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <!-- Recipes Grid -->
            <div id="recipesContainer" class="row">
                <!-- Recipes will be loaded here -->
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="text-center py-5" style="display: none;">
                <i class="fas fa-search text-muted" style="font-size: 4rem;"></i>
                <h3 class="text-muted mt-3">Không tìm thấy công thức nào</h3>
                <p class="text-muted">Hãy thử tìm kiếm với từ khóa khác</p>
            </div>
        </div>
    </div>
</div>

<!-- Recipe Detail Modal -->
<div class="modal fade" id="recipeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recipeModalTitle">Chi tiết công thức</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recipeModalBody">
                <!-- Recipe details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load recipes on page load
    document.addEventListener('DOMContentLoaded', loadRecipes);

    // Load all recipes
    async function loadRecipes() {
        showLoading(true);
        try {
            const response = await fetch('/api/guest/recipes');
            const data = await response.json();
            
            if (data.success) {
                displayRecipes(data.recipes);
            } else {
                showError('Không thể tải công thức');
            }
        } catch (error) {
            showError('Lỗi kết nối');
        }
        showLoading(false);
    }

    // Search recipes
    async function searchRecipes() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            loadRecipes();
            return;
        }

        showLoading(true);
        try {
            const response = await fetch(`/api/guest/recipes/search?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.success) {
                displayRecipes(data.recipes);
            } else {
                showError('Không thể tìm kiếm công thức');
            }
        } catch (error) {
            showError('Lỗi kết nối');
        }
        showLoading(false);
    }

    // Display recipes
    function displayRecipes(recipes) {
        const container = document.getElementById('recipesContainer');
        const noResults = document.getElementById('noResults');
        
        if (recipes.length === 0) {
            container.innerHTML = '';
            noResults.style.display = 'block';
            return;
        }
        
        noResults.style.display = 'none';
        container.innerHTML = recipes.map(recipe => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 recipe-card" onclick="showRecipeDetail(${recipe.id})">
                    <div class="card-body">
                        <h5 class="card-title">${recipe.name}</h5>
                        <p class="card-text text-muted">${recipe.description || 'Không có mô tả'}</p>
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i><br>
                                    ${recipe.prep_time + recipe.cook_time} phút
                                </small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">
                                    <i class="fas fa-users me-1"></i><br>
                                    ${recipe.servings} người
                                </small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">
                                    <i class="fas fa-fire me-1"></i><br>
                                    ${recipe.nutrition_info?.calories || 0} cal
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-outline-success btn-sm w-100">
                            <i class="fas fa-eye me-1"></i>Xem chi tiết
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Show recipe detail
    async function showRecipeDetail(recipeId) {
        try {
            const response = await fetch(`/api/guest/recipes/${recipeId}`);
            const data = await response.json();
            
            if (data.success) {
                const recipe = data.recipe;
                document.getElementById('recipeModalTitle').textContent = recipe.name;
                document.getElementById('recipeModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>Thông tin</h6>
                            <p><strong>Mô tả:</strong> ${recipe.description || 'Không có mô tả'}</p>
                            <p><strong>Thời gian chuẩn bị:</strong> ${recipe.prep_time} phút</p>
                            <p><strong>Thời gian nấu:</strong> ${recipe.cook_time} phút</p>
                            <p><strong>Khẩu phần:</strong> ${recipe.servings} người</p>
                            
                            <h6 class="mt-4"><i class="fas fa-fire me-2"></i>Dinh dưỡng (per serving)</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small><strong>Calories:</strong> ${recipe.nutrition_info?.calories || 0}</small><br>
                                    <small><strong>Protein:</strong> ${recipe.nutrition_info?.protein || 0}g</small>
                                </div>
                                <div class="col-6">
                                    <small><strong>Carbs:</strong> ${recipe.nutrition_info?.carbs || 0}g</small><br>
                                    <small><strong>Fat:</strong> ${recipe.nutrition_info?.fat || 0}g</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-list me-2"></i>Nguyên liệu</h6>
                            <ul class="list-unstyled">
                                ${recipe.ingredients?.map(ing => `
                                    <li><i class="fas fa-check text-success me-2"></i>${ing.name} - ${ing.quantity} ${ing.unit}</li>
                                `).join('') || '<li>Không có thông tin nguyên liệu</li>'}
                            </ul>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-clipboard-list me-2"></i>Cách làm</h6>
                            <div class="bg-light p-3 rounded">
                                ${recipe.instructions ? recipe.instructions.replace(/\n/g, '<br>') : 'Không có hướng dẫn'}
                            </div>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('recipeModal')).show();
            } else {
                showError('Không thể tải chi tiết công thức');
            }
        } catch (error) {
            showError('Lỗi kết nối');
        }
    }

    // Utility functions
    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
        alert(message); // Simple alert for now
    }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchRecipes();
        }
    });
</script>
{% endblock %}
